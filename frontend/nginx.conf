map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;

    # Hide Nginx version
    server_tokens off;

    # ================================================================
    # HTTPS REDIRECT (via Cloudflare X-Forwarded-Proto)
    # ================================================================
    # If the original request came over HTTP, redirect to HTTPS
    if ($http_x_forwarded_proto = "http") {
        return 301 https://$host$request_uri;
    }

    # ================================================================
    # REAL IP RESOLUTION (CLOUDFLARE)
    # ================================================================
    # Trust Docker internal networks to pass correct headers
    set_real_ip_from 10.0.0.0/8;
    set_real_ip_from 172.16.0.0/12;
    set_real_ip_from 192.168.0.0/16;
    # Cloudflare IP ranges (for direct Cloudflare connections)
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    # Use the header Cloudflare provides
    real_ip_header CF-Connecting-IP;

    # ================================================================
    # GZIP COMPRESSION
    # ================================================================
    # Allow larger uploads (default is 1m)
    client_max_body_size 10m;

    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/javascript
        text/xml
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-javascript
        image/svg+xml;

    # ================================================================
    # SECURITY HEADERS
    # ================================================================
    
    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Clickjacking protection
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # XSS protection (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Restrict browser features/APIs
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Content Security Policy (adjust as needed for your app)
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https:;" always;

    # ================================================================
    # BLOCK MALICIOUS REQUESTS
    # ================================================================
    
    # Block WordPress and common CMS vulnerability scans
    location ~* ^/(wp-admin|wp-login\.php|wp-includes|wp-content|xmlrpc\.php|wordpress|blog/wp-|web/wp-|wp1|wp/).*$ {
        return 404;
    }

    # Block environment file access attempts
    location ~* ^/(.*)\.env(.*)$ {
        return 404;
    }
    
    # Block everything under any .git directory
    location ~* ^/\.git(/|$) {
        return 404;
    }

    # Block specific files at root
    location ~* ^/(\.svn|\.htaccess|\.htpasswd|composer\.(json|lock)|package\.json|package-lock\.json|yarn\.lock|pnpm-lock\.yaml|\.DS_Store|Thumbs\.db)$ {
        return 404;
    }
    
    # Block PHP file access (we don't use PHP)
    location ~* \.php$ {
        return 404;
    }
    
    # Block DevOps and Cloud files
    # Note: 'auth' removed because /auth/google/callback is a legitimate OAuth route
    location ~* ^/(Dockerfile|docker-compose|kubernetes|k8s|aws|gcp|azure|secrets|credentials|token|key)(.*)$ {
        return 404;
    }
    
    # Block common file extensions for secrets/backups
    location ~* \.(sql|bak|old|backup|swp|config|save|zip|tar|gz|log|yml|yaml)$ {
        return 404;
    }

    # Block common attack paths
    location ~* ^/(admin|administrator|phpmyadmin|pma|mysql|database|db|config|setup|install|cgi-bin|feed)/ {
        return 404;
    }

    # ================================================================
    # HEALTH CHECK (for container orchestration)
    # ================================================================
    location = /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ================================================================
    # SERVE STATIC ASSETS
    # ================================================================
    
    # Serve robots.txt directly (don't fallback to SPA)
    location = /robots.txt {
        root /usr/share/nginx/html;
        access_log off;
        log_not_found off;
    }

    # Serve sitemap.xml directly
    location = /sitemap.xml {
        root /usr/share/nginx/html;
        access_log off;
        log_not_found off;
    }

    # Serve favicon directly
    location = /favicon.ico {
        root /usr/share/nginx/html;
        access_log off;
        log_not_found off;
    }

    location = /favicon.png {
        root /usr/share/nginx/html;
        access_log off;
        log_not_found off;
    }

    # Static assets with caching (hashed filenames from Vite)
    location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # ================================================================
    # MEDIA PROXY (uploaded files from backend)
    # ================================================================
    # IMPORTANT: use ^~ so regex static-asset locations (e.g. \.png$) don't
    # capture /media/* requests and try to serve them from disk.
    location ^~ /media/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache uploaded media files
        proxy_cache_valid 200 1d;
        expires 7d;
        add_header Cache-Control "public";
    }

    # ================================================================
    # MAIN APPLICATION
    # ================================================================
    
    # Serve the React application
    location / {
        root   /usr/share/nginx/html;
        index  index.html;
        # This is required for single-page applications (SPA) like React
        try_files $uri $uri/ /index.html;
        
        # No caching for HTML (always get latest version)
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # Security headers for HTML responses
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # ================================================================
    # API PROXY
    # ================================================================
    
    # Proxy API requests to the backend
    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support (for future use)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # API-specific security
        proxy_hide_header X-Powered-By;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering for larger responses
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
}
